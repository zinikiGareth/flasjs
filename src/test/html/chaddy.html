<html>
  <head>
  	<title>Chaddy</title>
  	<!-- use this, and then do getElementById('loginInfo').import to try and access the module
  	<link id='loginInfo' rel='import' href='login.html' />
  	-->
  	<link rel="stylesheet" type="text/css" href="../css/webflow.css">
  	<link rel="stylesheet" type="text/css" href="../css/normalize.css">
  	<link rel="stylesheet" type="text/css" href="../css/chaddy.webflow.css">
  	<link rel="stylesheet" type="text/css" href="../css/chaddy.css">
  	<script type='text/javascript' src='../javascript/flenv.js'></script>
  	<script type='text/javascript' src='../javascript/builtin.js'></script>
  	<script type='text/javascript' src='../javascript/stdlib.js'></script>
  	<script type='text/javascript' src='../javascript/dom.js'></script>
  	<script type='text/javascript' src='../javascript/loader.js'></script>
  	<script type='text/javascript' src='../javascript/atmosphere.js'></script>
  	<script type='text/javascript' src='../javascript/zinc.js'></script>
  	<script type='text/javascript' src='../javascript/flasck/flasck.js'></script>
  	<script type='text/javascript' src='../javascript/flasck/handle.js'></script>
  	<script type='text/javascript' src='../javascript/flasck/postbox.js'></script>
  	<script type='text/javascript' src='../javascript/flasck/services.js'></script>
  	<script type='text/javascript' src='../javascript/flasck/wrapper.js'></script>
  	<script type='text/javascript' src='../../../../FLAS2/src/test/resources/cards/com.helpfulsidekick.chaddy/com.helpfulsidekick.chaddy.js'></script>
  </head>
  <body>
    <dialog id='flasck_login'>
<form id="loginForm" class="form-horizontal full-page-form">
	<fieldset id="loginFields">
		<legend>Ziniki</legend>
		<!--
		{{#if guardOnDuty}}
		<div class="alert alert-info">{{guardOnDuty.label}}</div>
		{{/if}}
		-->
		<div class='form-group'>
			<label class="ziniki-control-label">Username</label>
			<div class="ziniki-controls"><input type='text' id="username" focused=true></div>
		</div>
		<div class='form-group'>
			<label class="ziniki-control-label">Password</label>
			<div class="ziniki-controls"><input type='password' id="password"></div>
		</div>
		<div>
			<div class="ziniki-unlabeled-controls"><button id="logInButton" type="button" class="btn btn-default" onclick='zinikiLogin()'>Log in</button></div>
		</div>
		<!--
		{{#if loginError}}
		<div class="form-group">
			<div class="ziniki-unlabeled-controls has-error"><span class="help-block" id="loginError">{{loginError}}</span></div>
		</div>
		{{/if}}
		-->
		<div class="form-group-spacer-medium">
		</div>
		<!--
		<div class="form-group">
			{{view "identityProviders" label="Or sign in with" actionVerb="Log in" activityName="login"}}
		</div>
		-->
		<!--
		{{#if userApprovalOfRegistration}}
		<div class="form-group">
			<div class="ziniki-unlabeled-controls-wide">
				<div class="alert alert-warning">
					{{userApprovalOfRegistration.credentialName}} hasn't yet been registered with Ziniki.
					{{#if registrationPromptsAreAllowed}}
					Would you like to register it now?
					<button id="userApprovalOfRegistrationYes" class="btn btn-warning" type="button" {{action "acceptApprovalOfRegistration"}}>Yes</button>
					{{/if}}
				</div>
			</div>
		</div>
		{{/if}}
		-->
		<!--
		{{#if registrationPromptsAreAllowed}}
		<div class="form-group-spacer-small">
		</div>
		<div class="form-group">
			<div class="ziniki-unlabeled-controls">
				{{#if userApprovalOfRegistration}}
				You can also {{#link-to 'register' id="register"}}register{{/link-to}} a different account, or a new username.
				{{else}}
				Or you can {{#link-to 'register' id="register"}}register{{/link-to}} a new account.
				{{/if}}
			</div>
		</div>
		{{/if}}
		-->
	</fieldset>
</form>
    </dialog>
  	<dialog id='flasck_popover'>
  		<div id='flasck_popover_chrome'>
  			<a style='text-decoration: none;' onclick='document.getElementById("flasck_popover").close()'>X</a>
  		</div>
  		<div id='flasck_popover_div'>
  		</div>
  	</dialog>
  	<script type='text/javascript'>
  	  	var doc = document;
  		var body = doc.getElementsByTagName("body")[0];
		var div = doc.createElement("div");
		body.appendChild(div);

		var postbox = new Postbox("main");
		var services = {};
		FlasckServices.provideAll(doc, postbox, services);

		function onOpen() {
			div.innerHTML='';
		    var handle = Flasck.createCard(postbox, div, { explicit: com.helpfulsidekick.chaddy.Main, mode: 'local' }, services);
		}

    	var isConnected = true;
		if (haveZiniki) {
	  		function zinikiLogin() {
	  	  		var user = doc.getElementById('username');
	  	  		var pwd = doc.getElementById('password');
	  	  		console.log("user: ", user.value, "password:", password.value);
		  		ZinikiConn.req.invoke('login', function(msg) { var payload = msg.payload; var token = payload['token'][0].token; localStorage.setItem('zintoken', token); doc.getElementById('flasck_login').close(); ZinikiConn.req.advanceConnectivity(); onOpen(); }).setOption('login', user.value).setOption('password', password.value).send();
	  		} 

			isConnected = false;
	  	  	ZinikiConn = { req: Zinc.newRequestor('http://localhost:10080/ziniki/adapter') };
			ZinikiConn.req.invoke('package/com.helpfulsidekick.chaddy').setOption('zinikiName', 'com.helpfulsidekick.omt.personal').setOption('version', 1).onConnect();
			function handleLogin(req) {
				var token = localStorage.getItem('zintoken');
				console.log("have token: ", token);
				if (token == null) {
					var lm = doc.getElementById('flasck_login');
					if (!lm.open)
						lm.showModal();
				} else
		  			req.invoke('token/' + token, function(msg) { console.log("received", msg); if (msg.error) { localStorage.removeItem('zintoken'); handleLogin(req); } else { req.advanceConnectivity(); onOpen(); } }).send();
			}
			ZinikiConn.req.onConnect(handleLogin, true);
  		}
		
		if (isConnected) {
			onOpen();
		}
  	</script>
  </body>
</html>